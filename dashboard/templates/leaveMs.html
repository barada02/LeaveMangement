<div class="leave-management-container">
    <h2>Pending Leave Applications</h2>
    
    <div class="pending-requests-table">
        <table>
            <thead>
                <tr>
                    <th>Employee Name</th>
                    <th>Leave Type</th>
                    <th>Duration</th>
                    <th>Applied On</th>
                    <th>Reason</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="pendingRequestsBody">
                <!-- Data will be loaded dynamically -->
            </tbody>
        </table>
    </div>
</div>

<style>
.leave-management-container {
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin: 20px;
}

.leave-management-container h2 {
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #eee;
}

.pending-requests-table {
    width: 100%;
    overflow-x: auto;
}

.pending-requests-table table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.pending-requests-table th,
.pending-requests-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.pending-requests-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.pending-requests-table tr:hover {
    background-color: #f8f9fa;
}

.btn-approve, .btn-reject {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    margin: 0 5px;
    transition: all 0.3s ease;
}

.btn-approve {
    background-color: #28a745;
    color: white;
}

.btn-reject {
    background-color: #dc3545;
    color: white;
}

.btn-approve:hover {
    background-color: #218838;
}

.btn-reject:hover {
    background-color: #c82333;
}

.duration-cell {
    white-space: nowrap;
}

.reason-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.no-data {
    text-align: center;
    padding: 20px;
    color: #666;
    font-style: italic;
}
</style>

<script>
// Load data when document is ready
$(document).ready(function() {
    loadPendingRequests();
    // Refresh the list every 5 minutes
    setInterval(loadPendingRequests, 300000);
});

function formatDuration(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    return `${start.toLocaleDateString()} to ${end.toLocaleDateString()} (${days} days)`;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function loadPendingRequests() {
    const tbody = $('#pendingRequestsBody');
    tbody.html('<tr><td colspan="6" class="no-data">Loading...</td></tr>');
    
    $.ajax({
        url: '../api/admin_leave.php',
        type: 'GET',
        data: { action: 'pending' },
        dataType: 'json',
        success: function(response) {
            tbody.empty();
            
            if (!response.status) {
                tbody.html(`<tr><td colspan="6" class="no-data">Error: ${response.message}</td></tr>`);
                return;
            }
            
            if (!response.data || response.data.length === 0) {
                tbody.html('<tr><td colspan="6" class="no-data">No pending leave requests</td></tr>');
                return;
            }
            
            response.data.forEach(request => {
                const row = `
                    <tr>
                        <td>${request.employee_name || 'Unknown'}</td>
                        <td>${request.leave_type}</td>
                        <td class="duration-cell">${formatDuration(request.start_date, request.end_date)}</td>
                        <td>${formatDate(request.date_applied)}</td>
                        <td class="reason-cell" title="${request.reason}">${request.reason || '-'}</td>
                        <td>
                            <button class="btn-approve" onclick="handleLeaveAction(${request.leave_log_id}, 'approved')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn-reject" onclick="handleLeaveAction(${request.leave_log_id}, 'rejected')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        },
        error: function(xhr, status, error) {
            tbody.html(`<tr><td colspan="6" class="no-data">Error loading requests. Please try again.</td></tr>`);
        }
    });
}

function handleLeaveAction(leaveId, status) {
    const note = prompt('Add a note (optional):');
    
    $.ajax({
        url: '../api/admin_leave.php',
        type: 'POST',
        data: {
            action: 'update',
            leave_id: leaveId,
            status: status,
            note: note
        },
        dataType: 'json',
        success: function(response) {
            if (response.status) {
                alert('Leave request ' + status + ' successfully');
                loadPendingRequests();
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function() {
            alert('Error updating leave request. Please try again.');
        }
    });
}
</script>
